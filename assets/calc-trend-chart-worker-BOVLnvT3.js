function m(r,e){const s=[];for(let t=e-1;t<r.length;t++){const a=r.slice(t-e+1,t+1).reduce((c,u)=>c+parseFloat(u[4]),0)/e;s.push({date:r[t][0],value:Number(a.toFixed(2))})}return s}function w(r,e=20,s=2){const t=m(r,e),n=[];for(let o=0;o<t.length;o++){const a=o+e-1,u=r.slice(a-e+1,a+1).map(i=>parseFloat(i[4])),l=t[o].value,f=u.reduce((i,h)=>i+Math.pow(h-l,2),0)/e,d=Math.sqrt(f);n.push({date:t[o].date,upper:Number((l+s*d).toFixed(2)),middle:l,lower:Number((l-s*d).toFixed(2))})}return n}const g={calcTrend:async function(r){try{const{stockData:e,trendParams:s={}}=r;if(!e||e.length===0)throw new Error("股價資料為空");const{maPeriod:t=20,bbPeriod:n=20,bbStdDev:o=2}=s,a=m(e,t),c=w(e,n,o);return{success:!0,movingAverage:a,bollingerBands:c,processedAt:new Date().toISOString()}}catch(e){return{success:!1,error:e.message,processedAt:new Date().toISOString()}}},ping:async function(){return"Trend Worker Pong! "+new Date().toISOString()}};self.onmessage=async function(r){const{messageId:e,method:s,params:t}=r.data;try{if(g[s]){const n=await g[s](t);self.postMessage({messageId:e,result:n,error:null})}else throw new Error(`未知的方法: ${s}`)}catch(n){self.postMessage({messageId:e,result:null,error:n.message})}};
