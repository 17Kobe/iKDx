function Me(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var G={exports:{}},Se=G.exports,fe;function Ie(){return fe||(fe=1,function(t,e){(function(r,l){t.exports=l()})(Se,function(){var r=1e3,l=6e4,D=36e5,h="millisecond",d="second",i="minute",u="hour",a="day",y="week",m="month",k="quarter",v="year",w="date",b="Invalid Date",_=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,O=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,B={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),ordinal:function(f){var o=["th","st","nd","rd"],n=f%100;return"["+f+(o[(n-20)%10]||o[n]||o[0])+"]"}},L=function(f,o,n){var c=String(f);return!c||c.length>=o?f:""+Array(o+1-c.length).join(n)+f},T={s:L,z:function(f){var o=-f.utcOffset(),n=Math.abs(o),c=Math.floor(n/60),s=n%60;return(o<=0?"+":"-")+L(c,2,"0")+":"+L(s,2,"0")},m:function f(o,n){if(o.date()<n.date())return-f(n,o);var c=12*(n.year()-o.year())+(n.month()-o.month()),s=o.clone().add(c,m),g=n-s<0,$=o.clone().add(c+(g?-1:1),m);return+(-(c+(n-s)/(g?s-$:$-s))||0)},a:function(f){return f<0?Math.ceil(f)||0:Math.floor(f)},p:function(f){return{M:m,y:v,w:y,d:a,D:w,h:u,m:i,s:d,ms:h,Q:k}[f]||String(f||"").toLowerCase().replace(/s$/,"")},u:function(f){return f===void 0}},E="en",x={};x[E]=B;var U="$isDayjsObject",Z=function(f){return f instanceof q||!(!f||!f[U])},C=function f(o,n,c){var s;if(!o)return E;if(typeof o=="string"){var g=o.toLowerCase();x[g]&&(s=g),n&&(x[g]=n,s=g);var $=o.split("-");if(!s&&$.length>1)return f($[0])}else{var p=o.name;x[p]=o,s=p}return!c&&s&&(E=s),s||!c&&E},I=function(f,o){if(Z(f))return f.clone();var n=typeof o=="object"?o:{};return n.date=f,n.args=arguments,new q(n)},M=T;M.l=C,M.i=Z,M.w=function(f,o){return I(f,{locale:o.$L,utc:o.$u,x:o.$x,$offset:o.$offset})};var q=function(){function f(n){this.$L=C(n.locale,null,!0),this.parse(n),this.$x=this.$x||n.x||{},this[U]=!0}var o=f.prototype;return o.parse=function(n){this.$d=function(c){var s=c.date,g=c.utc;if(s===null)return new Date(NaN);if(M.u(s))return new Date;if(s instanceof Date)return new Date(s);if(typeof s=="string"&&!/Z$/i.test(s)){var $=s.match(_);if($){var p=$[2]-1||0,S=($[7]||"0").substring(0,3);return g?new Date(Date.UTC($[1],p,$[3]||1,$[4]||0,$[5]||0,$[6]||0,S)):new Date($[1],p,$[3]||1,$[4]||0,$[5]||0,$[6]||0,S)}}return new Date(s)}(n),this.init()},o.init=function(){var n=this.$d;this.$y=n.getFullYear(),this.$M=n.getMonth(),this.$D=n.getDate(),this.$W=n.getDay(),this.$H=n.getHours(),this.$m=n.getMinutes(),this.$s=n.getSeconds(),this.$ms=n.getMilliseconds()},o.$utils=function(){return M},o.isValid=function(){return this.$d.toString()!==b},o.isSame=function(n,c){var s=I(n);return this.startOf(c)<=s&&s<=this.endOf(c)},o.isAfter=function(n,c){return I(n)<this.startOf(c)},o.isBefore=function(n,c){return this.endOf(c)<I(n)},o.$g=function(n,c,s){return M.u(n)?this[c]:this.set(s,n)},o.unix=function(){return Math.floor(this.valueOf()/1e3)},o.valueOf=function(){return this.$d.getTime()},o.startOf=function(n,c){var s=this,g=!!M.u(c)||c,$=M.p(n),p=function(H,j){var K=M.w(s.$u?Date.UTC(s.$y,j,H):new Date(s.$y,j,H),s);return g?K:K.endOf(a)},S=function(H,j){return M.w(s.toDate()[H].apply(s.toDate("s"),(g?[0,0,0,0]:[23,59,59,999]).slice(j)),s)},Y=this.$W,W=this.$M,P=this.$D,F="set"+(this.$u?"UTC":"");switch($){case v:return g?p(1,0):p(31,11);case m:return g?p(1,W):p(0,W+1);case y:var R=this.$locale().weekStart||0,N=(Y<R?Y+7:Y)-R;return p(g?P-N:P+(6-N),W);case a:case w:return S(F+"Hours",0);case u:return S(F+"Minutes",1);case i:return S(F+"Seconds",2);case d:return S(F+"Milliseconds",3);default:return this.clone()}},o.endOf=function(n){return this.startOf(n,!1)},o.$set=function(n,c){var s,g=M.p(n),$="set"+(this.$u?"UTC":""),p=(s={},s[a]=$+"Date",s[w]=$+"Date",s[m]=$+"Month",s[v]=$+"FullYear",s[u]=$+"Hours",s[i]=$+"Minutes",s[d]=$+"Seconds",s[h]=$+"Milliseconds",s)[g],S=g===a?this.$D+(c-this.$W):c;if(g===m||g===v){var Y=this.clone().set(w,1);Y.$d[p](S),Y.init(),this.$d=Y.set(w,Math.min(this.$D,Y.daysInMonth())).$d}else p&&this.$d[p](S);return this.init(),this},o.set=function(n,c){return this.clone().$set(n,c)},o.get=function(n){return this[M.p(n)]()},o.add=function(n,c){var s,g=this;n=Number(n);var $=M.p(c),p=function(W){var P=I(g);return M.w(P.date(P.date()+Math.round(W*n)),g)};if($===m)return this.set(m,this.$M+n);if($===v)return this.set(v,this.$y+n);if($===a)return p(1);if($===y)return p(7);var S=(s={},s[i]=l,s[u]=D,s[d]=r,s)[$]||1,Y=this.$d.getTime()+n*S;return M.w(Y,this)},o.subtract=function(n,c){return this.add(-1*n,c)},o.format=function(n){var c=this,s=this.$locale();if(!this.isValid())return s.invalidDate||b;var g=n||"YYYY-MM-DDTHH:mm:ssZ",$=M.z(this),p=this.$H,S=this.$m,Y=this.$M,W=s.weekdays,P=s.months,F=s.meridiem,R=function(j,K,J,z){return j&&(j[K]||j(c,g))||J[K].slice(0,z)},N=function(j){return M.s(p%12||12,j,"0")},H=F||function(j,K,J){var z=j<12?"AM":"PM";return J?z.toLowerCase():z};return g.replace(O,function(j,K){return K||function(J){switch(J){case"YY":return String(c.$y).slice(-2);case"YYYY":return M.s(c.$y,4,"0");case"M":return Y+1;case"MM":return M.s(Y+1,2,"0");case"MMM":return R(s.monthsShort,Y,P,3);case"MMMM":return R(P,Y);case"D":return c.$D;case"DD":return M.s(c.$D,2,"0");case"d":return String(c.$W);case"dd":return R(s.weekdaysMin,c.$W,W,2);case"ddd":return R(s.weekdaysShort,c.$W,W,3);case"dddd":return W[c.$W];case"H":return String(p);case"HH":return M.s(p,2,"0");case"h":return N(1);case"hh":return N(2);case"a":return H(p,S,!0);case"A":return H(p,S,!1);case"m":return String(S);case"mm":return M.s(S,2,"0");case"s":return String(c.$s);case"ss":return M.s(c.$s,2,"0");case"SSS":return M.s(c.$ms,3,"0");case"Z":return $}return null}(j)||$.replace(":","")})},o.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},o.diff=function(n,c,s){var g,$=this,p=M.p(c),S=I(n),Y=(S.utcOffset()-this.utcOffset())*l,W=this-S,P=function(){return M.m($,S)};switch(p){case v:g=P()/12;break;case m:g=P();break;case k:g=P()/3;break;case y:g=(W-Y)/6048e5;break;case a:g=(W-Y)/864e5;break;case u:g=W/D;break;case i:g=W/l;break;case d:g=W/r;break;default:g=W}return s?g:M.a(g)},o.daysInMonth=function(){return this.endOf(m).$D},o.$locale=function(){return x[this.$L]},o.locale=function(n,c){if(!n)return this.$L;var s=this.clone(),g=C(n,c,!0);return g&&(s.$L=g),s},o.clone=function(){return M.w(this.$d,this)},o.toDate=function(){return new Date(this.valueOf())},o.toJSON=function(){return this.isValid()?this.toISOString():null},o.toISOString=function(){return this.$d.toISOString()},o.toString=function(){return this.$d.toUTCString()},f}(),de=q.prototype;return I.prototype=de,[["$ms",h],["$s",d],["$m",i],["$H",u],["$W",a],["$M",m],["$y",v],["$D",w]].forEach(function(f){de[f[1]]=function(o){return this.$g(o,f[0],f[1])}}),I.extend=function(f,o){return f.$i||(f(o,q,I),f.$i=!0),I},I.locale=C,I.isDayjs=Z,I.unix=function(f){return I(1e3*f)},I.en=x[E],I.Ls=x,I.p={},I})}(G)),G.exports}var Ye=Ie(),A=Me(Ye),Q={exports:{}},Oe=Q.exports,he;function xe(){return he||(he=1,function(t,e){(function(r,l){t.exports=l()})(Oe,function(){var r="day";return function(l,D,h){var d=function(a){return a.add(4-a.isoWeekday(),r)},i=D.prototype;i.isoWeekYear=function(){return d(this).year()},i.isoWeek=function(a){if(!this.$utils().u(a))return this.add(7*(a-this.isoWeek()),r);var y,m,k,v,w=d(this),b=(y=this.isoWeekYear(),m=this.$u,k=(m?h.utc:h)().year(y).startOf("year"),v=4-k.isoWeekday(),k.isoWeekday()>4&&(v+=7),k.add(v,r));return w.diff(b,"week")+1},i.isoWeekday=function(a){return this.$utils().u(a)?this.day()||7:this.day(this.day()%7?a:a-7)};var u=i.startOf;i.startOf=function(a,y){var m=this.$utils(),k=!!m.u(y)||y;return m.p(a)==="isoweek"?k?this.date(this.date()-(this.isoWeekday()-1)).startOf("day"):this.date(this.date()-1-(this.isoWeekday()-1)+7).endOf("day"):u.bind(this)(a,y)}}})}(Q)),Q.exports}var We=xe(),be=Me(We);const ie=(t,e)=>e.some(r=>t instanceof r);let ge,$e;function je(){return ge||(ge=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function Be(){return $e||($e=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const ae=new WeakMap,ee=new WeakMap,X=new WeakMap;function Le(t){const e=new Promise((r,l)=>{const D=()=>{t.removeEventListener("success",h),t.removeEventListener("error",d)},h=()=>{r(V(t.result)),D()},d=()=>{l(t.error),D()};t.addEventListener("success",h),t.addEventListener("error",d)});return X.set(e,t),e}function Pe(t){if(ae.has(t))return;const e=new Promise((r,l)=>{const D=()=>{t.removeEventListener("complete",h),t.removeEventListener("error",d),t.removeEventListener("abort",d)},h=()=>{r(),D()},d=()=>{l(t.error||new DOMException("AbortError","AbortError")),D()};t.addEventListener("complete",h),t.addEventListener("error",d),t.addEventListener("abort",d)});ae.set(t,e)}let ce={get(t,e,r){if(t instanceof IDBTransaction){if(e==="done")return ae.get(t);if(e==="store")return r.objectStoreNames[1]?void 0:r.objectStore(r.objectStoreNames[0])}return V(t[e])},set(t,e,r){return t[e]=r,!0},has(t,e){return t instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in t}};function pe(t){ce=t(ce)}function _e(t){return Be().includes(t)?function(...e){return t.apply(ue(this),e),V(this.request)}:function(...e){return V(t.apply(ue(this),e))}}function Ee(t){return typeof t=="function"?_e(t):(t instanceof IDBTransaction&&Pe(t),ie(t,je())?new Proxy(t,ce):t)}function V(t){if(t instanceof IDBRequest)return Le(t);if(ee.has(t))return ee.get(t);const e=Ee(t);return e!==t&&(ee.set(t,e),X.set(e,t)),e}const ue=t=>X.get(t);function Ae(t,e,{blocked:r,upgrade:l,blocking:D,terminated:h}={}){const d=indexedDB.open(t,e),i=V(d);return l&&d.addEventListener("upgradeneeded",u=>{l(V(d.result),u.oldVersion,u.newVersion,V(d.transaction),u)}),r&&d.addEventListener("blocked",u=>r(u.oldVersion,u.newVersion,u)),i.then(u=>{h&&u.addEventListener("close",()=>h()),D&&u.addEventListener("versionchange",a=>D(a.oldVersion,a.newVersion,a))}).catch(()=>{}),i}const Te=["get","getKey","getAll","getAllKeys","count"],Ce=["put","add","delete","clear"],te=new Map;function ye(t,e){if(!(t instanceof IDBDatabase&&!(e in t)&&typeof e=="string"))return;if(te.get(e))return te.get(e);const r=e.replace(/FromIndex$/,""),l=e!==r,D=Ce.includes(r);if(!(r in(l?IDBIndex:IDBObjectStore).prototype)||!(D||Te.includes(r)))return;const h=async function(d,...i){const u=this.transaction(d,D?"readwrite":"readonly");let a=u.store;return l&&(a=a.index(i.shift())),(await Promise.all([a[r](...i),D&&u.done]))[0]};return te.set(e,h),h}pe(t=>({...t,get:(e,r,l)=>ye(e,r)||t.get(e,r,l),has:(e,r)=>!!ye(e,r)||t.has(e,r)}));const Ke=["continue","continuePrimaryKey","advance"],me={},le=new WeakMap,ke=new WeakMap,Re={get(t,e){if(!Ke.includes(e))return t[e];let r=me[e];return r||(r=me[e]=function(...l){le.set(this,ke.get(this)[e](...l))}),r}};async function*He(...t){let e=this;if(e instanceof IDBCursor||(e=await e.openCursor(...t)),!e)return;e=e;const r=new Proxy(e,Re);for(ke.set(r,e),X.set(r,ue(e));e;)yield r,e=await(le.get(r)||e.continue()),le.delete(r)}function De(t,e){return e===Symbol.asyncIterator&&ie(t,[IDBIndex,IDBObjectStore,IDBCursor])||e==="iterate"&&ie(t,[IDBIndex,IDBObjectStore])}pe(t=>({...t,get(e,r,l){return De(e,r)?He:t.get(e,r,l)},has(e,r){return De(e,r)||t.has(e,r)}}));let ne=null;async function Ve(){return ne||(ne=await Ae("ikdx-db",1,{upgrade(t,e,r){e<1&&(t.createObjectStore("all-stocks",{keyPath:"id"}),t.createObjectStore("user-stock-info",{keyPath:"id"}).createIndex("orderIndex","order"),t.createObjectStore("user-stock-data",{keyPath:"id"}))}})),ne}function ve(){return Ve()}async function Fe(t,e){return(await ve()).get(t,e)}async function Ne(t,e){return(await ve()).put(t,e)}A.extend(be);function re(t){if(!t||t.length===0)return[];const e=(y,m,k)=>y.slice(m,k),r=(y,m)=>y.map(m),l=y=>Math.min(...y),D=y=>Math.max(...y),h=y=>y.reduce((m,k)=>m+k,0),d=[];let i=t.length-1,u=i,a=A(t[i][0],"YYYYMMDD").startOf("isoWeek");for(;i>=0;){if(A(t[i][0],"YYYYMMDD").isBefore(a)||i===0){const y=i+1,m=u,k=e(t,y,m+1),v=r(k,x=>x[2]),w=r(k,x=>x[3]),b=r(k,x=>x.length>=6?x[5]:0),_=t[m][0],O=t[y][1],B=t[m][4],L=l(w),T=D(v),E=h(b);d.push([_,O,T,L,B,E]),u=y-1,a=A(t[i][0],"YYYYMMDD").startOf("isoWeek")}i-=1}return d.reverse()}function se(t){if(!t||t.length===0)return{data:[],predictGoldPrice:null,predictDeadPrice:null};const e=(w,b,_)=>w.slice(b,_),r=(w,b)=>w.map(b),l=w=>Math.min(...w),D=w=>Math.max(...w);let h=[],d=0,i=0,u=0,a=0,y=0,m=0,k=null,v=null;for(let w=0;w<=t.length-1;w+=1){const b=w-8<0?0:w-8,_=w,O=e(t,b,_+1),B=r(O,C=>C[2]),L=r(O,C=>C[3]),T=l(L),E=D(B),x=t[w][4];d=E-T!==0?(x-T)/(E-T)*100:100,a=2/3*i+1/3*d,y=2/3*u+1/3*a,m=3*y-2*a,i=a,u=y;const U=t[_][0];h.push([U,a,y,m]),w===t.length-1&&(B.slice(0,-1),L.slice(0,-1),B[B.length-1],L[L.length-1])}return{data:h,predictGoldPrice:k,predictDeadPrice:v}}function oe(t){if(!t||t.length===0)return[];const e=5;let r=[],l=[],D=[],h=0,d=0;for(let i=0;i<t.length;i++){let u=t[i][4];if(i===0)l.push(0),D.push(0);else{let a=u-t[i-1][4];l.push(Math.max(a,0)),D.push(Math.max(-a,0))}if(i>=e?(h=(h*(e-1)+l[i])/e,d=(d*(e-1)+D[i])/e):(h=(h*(i+1)+l[i])/(i+2),d=(d*(i+1)+D[i])/(i+2)),i>=e-1){let a=h/d;r.push([t[i][0],100-100/(1+a)])}}return r}const we={calcPolicy:async function(t){try{const{stockId:e,type:r,newDailyData:l,...D}=t;if(!e)throw new Error("stockId 參數必須提供");let h=await Fe("user-stock-data",e),d=[],i=[];console.log(`[${e}] 開始處理股票資料`),console.log(`[${e}] 新增日線資料筆數:`,l?l.length:0),h&&h.daily?(d=[...h.daily],i=h.weekly||[],console.log(`[${e}] 現有日線資料筆數:`,d.length),console.log(`[${e}] 現有週線資料筆數:`,i.length)):console.log(`[${e}] 無現有資料，從零開始計算`),l&&l.length>0&&(d=[...d,...l],console.log(`[${e}] 合併後總日線資料筆數:`,d.length));let u=[];if(l&&l.length>0&&i.length>0){console.log(`[${e}] 執行增量週線計算`);const v=i[i.length-1][0],w=A(v,"YYYYMMDD").startOf("isoWeek");console.log(`[${e}] 最後現有週線日期:`,v,"週開始:",w.format("YYYY-MM-DD"));const b=l[0][0],_=A(b,"YYYYMMDD").startOf("isoWeek");if(console.log(`[${e}] 第一筆新資料日期:`,b,"週開始:",_.format("YYYY-MM-DD")),_.isSameOrBefore(w)){console.log(`[${e}] 新資料會影響最後一週，重新計算受影響週線`);const O=d.filter(L=>A(L[0],"YYYYMMDD").startOf("isoWeek").isSameOrAfter(w));console.log(`[${e}] 需要重新計算的日線資料筆數:`,O.length),console.log(`[${e}] 重新計算範圍: ${O[0][0]} ~ ${O[O.length-1][0]}`);const B=re(O);console.log(`[${e}] 重新計算得到週線筆數:`,B.length),u=[...i.slice(0,-1),...B],console.log(`[${e}] 保留現有週線:`,i.length-1,"筆，新增:",B.length,"筆")}else{console.log(`[${e}] 新資料不影響現有週線，只計算新週線`);const O=re(l);console.log(`[${e}] 新週線資料筆數:`,O.length),u=[...i,...O],console.log(`[${e}] 現有週線:`,i.length,"筆，新增:",O.length,"筆")}}else console.log(`[${e}] 執行完整週線計算 (無現有資料或無新資料)`),u=re(d),console.log(`[${e}] 完整計算得到週線筆數:`,u.length);if(console.log(`[${e}] 最終週線資料筆數:`,u.length),console.log(`[${e}] 最終週線資料筆數:`,u.length),u.length===0)throw new Error("無法產生週線資料，請檢查日線資料格式");let a,y;if(console.log(`[${e}] 開始計算技術指標`),h&&h.weeklyKdj&&h.weeklyRsi&&i.length>0&&u.length>i.length){console.log(`[${e}] 檢查是否可以增量計算技術指標`),console.log(`[${e}] 現有KDJ資料筆數:`,h.weeklyKdj.length),console.log(`[${e}] 現有RSI資料筆數:`,h.weeklyRsi.length);const v=u.length-i.length;console.log(`[${e}] 新增週線筆數:`,v),v===u.length-i.length&&v<=2?(console.log(`[${e}] 少量新週線，使用增量計算邏輯`),a=se(u),y=oe(u)):(console.log(`[${e}] 較多變動，重新計算全部技術指標`),a=se(u),y=oe(u))}else console.log(`[${e}] 無現有技術指標資料，重新計算全部`),a=se(u),y=oe(u);console.log(`[${e}] KDJ計算完成，資料筆數:`,a.data?a.data.length:0),console.log(`[${e}] RSI計算完成，資料筆數:`,y?y.length:0),console.log(`[${e}] KDJ計算完成，資料筆數:`,a.data?a.data.length:0),console.log(`[${e}] RSI計算完成，資料筆數:`,y?y.length:0);const m={id:e,daily:d,weekly:u,weeklyKdj:a.data,weeklyRsi:y,lastUpdated:A().format("YYYY-MM-DD HH:mm:ss"),fetchedAt:A().format("YYYY-MM-DD HH:mm:ss")};console.log(`[${e}] 準備儲存資料到 IndexedDB`),console.log(`[${e}] 儲存資料摘要: 日線${m.daily.length}筆, 週線${m.weekly.length}筆, KDJ${m.weeklyKdj.length}筆, RSI${m.weeklyRsi.length}筆`),h&&(console.log(`[${e}] 合併現有資料`),Object.assign(m,h,m)),await Ne("user-stock-data",m),console.log(`[${e}] 資料已成功儲存到 IndexedDB`);const k={success:!0,stockId:e,weekly:u.slice(-26),weeklyKdj:a.data.slice(-26),weeklyRsi:y.slice(-26),processedAt:new Date().toISOString()};return console.log(`[${e}] 回傳結果: 週線${k.weekly.length}筆, KDJ${k.weeklyKdj.length}筆, RSI${k.weeklyRsi.length}筆`),k}catch(e){return{success:!1,error:e.message,processedAt:new Date().toISOString()}}},ping:async function(){return"Native Worker Pong! "+new Date().toISOString()}};self.onmessage=async function(t){const{messageId:e,method:r,params:l}=t.data;try{if(we[r]){const D=await we[r](l);self.postMessage({messageId:e,result:D,error:null})}else throw new Error(`未知的方法: ${r}`)}catch(D){self.postMessage({messageId:e,result:null,error:D.message})}};
