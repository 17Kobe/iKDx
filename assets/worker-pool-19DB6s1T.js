import{aL as T}from"./index-B-d6pzHU.js";/**
 * @license
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const I=Symbol("Comlink.proxy"),O=Symbol("Comlink.endpoint"),v=Symbol("Comlink.releaseProxy"),w=Symbol("Comlink.finalizer"),d=Symbol("Comlink.thrown"),R=r=>typeof r=="object"&&r!==null||typeof r=="function",Y={canHandle:r=>R(r)&&r[I],serialize(r){const{port1:e,port2:o}=new MessageChannel;return A(r,e),[o,[o]]},deserialize(r){return r.start(),y(r)}},U={canHandle:r=>R(r)&&d in r,serialize({value:r}){let e;return r instanceof Error?e={isError:!0,value:{message:r.message,name:r.name,stack:r.stack}}:e={isError:!1,value:r},[e,[]]},deserialize(r){throw r.isError?Object.assign(new Error(r.value.message),r.value):r.value}},E=new Map([["proxy",Y],["throw",U]]);function B(r,e){for(const o of r)if(e===o||o==="*"||o instanceof RegExp&&o.test(e))return!0;return!1}function A(r,e=globalThis,o=["*"]){e.addEventListener("message",function t(s){if(!s||!s.data)return;if(!B(o,s.origin)){console.warn(`Invalid origin '${s.origin}' for comlink proxy`);return}const{id:i,type:a,path:l}=Object.assign({path:[]},s.data),n=(s.data.argumentList||[]).map(m);let c;try{const u=l.slice(0,-1).reduce((g,f)=>g[f],r),h=l.reduce((g,f)=>g[f],r);switch(a){case"GET":c=h;break;case"SET":u[l.slice(-1)[0]]=m(s.data.value),c=!0;break;case"APPLY":c=h.apply(u,n);break;case"CONSTRUCT":{const g=new h(...n);c=L(g)}break;case"ENDPOINT":{const{port1:g,port2:f}=new MessageChannel;A(r,f),c=z(g,[g])}break;case"RELEASE":c=void 0;break;default:return}}catch(u){c={value:u,[d]:0}}Promise.resolve(c).catch(u=>({value:u,[d]:0})).then(u=>{const[h,g]=C(u);e.postMessage(Object.assign(Object.assign({},h),{id:i}),g),a==="RELEASE"&&(e.removeEventListener("message",t),N(e),w in r&&typeof r[w]=="function"&&r[w]())}).catch(u=>{const[h,g]=C({value:new TypeError("Unserializable return value"),[d]:0});e.postMessage(Object.assign(Object.assign({},h),{id:i}),g)})}),e.start&&e.start()}function H(r){return r.constructor.name==="MessagePort"}function N(r){H(r)&&r.close()}function y(r,e){const o=new Map;return r.addEventListener("message",function(s){const{data:i}=s;if(!i||!i.id)return;const a=o.get(i.id);if(a)try{a(i)}finally{o.delete(i.id)}}),S(r,o,[],e)}function p(r){if(r)throw new Error("Proxy has been released and is not useable")}function K(r){return k(r,new Map,{type:"RELEASE"}).then(()=>{N(r)})}const b=new WeakMap,W="FinalizationRegistry"in globalThis&&new FinalizationRegistry(r=>{const e=(b.get(r)||0)-1;b.set(r,e),e===0&&K(r)});function Z(r,e){const o=(b.get(e)||0)+1;b.set(e,o),W&&W.register(r,e,r)}function D(r){W&&W.unregister(r)}function S(r,e,o=[],t=function(){}){let s=!1;const i=new Proxy(t,{get(a,l){if(p(s),l===v)return()=>{D(i),K(r),e.clear(),s=!0};if(l==="then"){if(o.length===0)return{then:()=>i};const n=k(r,e,{type:"GET",path:o.map(c=>c.toString())}).then(m);return n.then.bind(n)}return S(r,e,[...o,l])},set(a,l,n){p(s);const[c,u]=C(n);return k(r,e,{type:"SET",path:[...o,l].map(h=>h.toString()),value:c},u).then(m)},apply(a,l,n){p(s);const c=o[o.length-1];if(c===O)return k(r,e,{type:"ENDPOINT"}).then(m);if(c==="bind")return S(r,e,o.slice(0,-1));const[u,h]=P(n);return k(r,e,{type:"APPLY",path:o.map(g=>g.toString()),argumentList:u},h).then(m)},construct(a,l){p(s);const[n,c]=P(l);return k(r,e,{type:"CONSTRUCT",path:o.map(u=>u.toString()),argumentList:n},c).then(m)}});return Z(i,r),i}function J(r){return Array.prototype.concat.apply([],r)}function P(r){const e=r.map(C);return[e.map(o=>o[0]),J(e.map(o=>o[1]))]}const x=new WeakMap;function z(r,e){return x.set(r,e),r}function L(r){return Object.assign(r,{[I]:!0})}function C(r){for(const[e,o]of E)if(o.canHandle(r)){const[t,s]=o.serialize(r);return[{type:"HANDLER",name:e,value:t},s]}return[{type:"RAW",value:r},x.get(r)||[]]}function m(r){switch(r.type){case"HANDLER":return E.get(r.name).deserialize(r.value);case"RAW":return r.value}}function k(r,e,o,t){return new Promise(s=>{const i=M();e.set(i,s),r.start&&r.start(),r.postMessage(Object.assign({id:i},o),t)})}function M(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}const q=Object.freeze(Object.defineProperty({__proto__:null,createEndpoint:O,expose:A,finalizer:w,proxy:L,proxyMarker:I,releaseProxy:v,transfer:z,transferHandlers:E,wrap:y},Symbol.toStringTag,{value:"Module"}));function X(){const r=navigator.userAgent;return/iPad|iPhone|iPod/.test(r)}function j(r,e=""){const o={context:e,timestamp:new Date().toISOString(),type:r.type||"unknown",message:r.message||"No message",filename:r.filename||"Unknown file",lineno:r.lineno||"Unknown line",colno:r.colno||"Unknown column"};r.error&&(o.errorObject={name:r.error.name||"Unknown",message:r.error.message||"No message",stack:r.error.stack||"No stack trace"});try{const t=Object.getOwnPropertyNames(r);o.eventProperties={},t.forEach(s=>{try{const i=r[s];typeof i!="function"&&(o.eventProperties[s]=i)}catch(i){o.eventProperties[s]=`[Unable to access: ${i.message}]`}})}catch(t){o.serializationError=t.message}return o.environment={userAgent:navigator.userAgent,isIOS:/iPad|iPhone|iPod/.test(navigator.userAgent),isMobile:/Mobile|Android|iPhone|iPad/.test(navigator.userAgent),language:navigator.language,platform:navigator.platform,onLine:navigator.onLine},o}function Q(r,e=""){const o=j(r,e);return console.error(`🚨 ${e} 詳細錯誤報告:`),console.error("📍 基本資訊:",{類型:o.type,訊息:o.message,檔案:o.filename,行號:o.lineno,列號:o.colno,時間:o.timestamp}),o.errorObject&&console.error("🔍 錯誤物件:",o.errorObject),o.eventProperties&&console.error("📋 事件屬性:",o.eventProperties),console.error("🌐 環境資訊:",o.environment),console.error("📄 完整錯誤 JSON:",JSON.stringify(o,null,2)),o}class G{constructor(e,o=navigator.hardwareConcurrency||4){this.workerUrl=e,this.maxWorkers=Math.min(o,4),this.workers=[],this.availableWorkers=[],this.queue=[],this.activeJobs=0,this.statusCallbacks=new Set,this.initialized=!1,this.initError=null,this.initPromise=null,this.isIOSMode=!1,this.iosPool=null,console.log("Worker Pool 構造函數調試:",{workerUrl:e,workerUrlType:typeof e,workerUrlString:e.toString(),isURL:e instanceof URL}),X()?(console.log("🍎 檢測到 iOS 裝置，啟用原生 Worker Pool 模式"),this.isIOSMode=!0,this.initPromise=this.initializeIOSWorkers()):this.initPromise=this.initializeWorkers()}async initializeIOSWorkers(){console.log("🍎 iOS 裝置專用 Worker Pool 初始化開始（使用 Classic Worker）...");try{const e=this.workerUrl.toString();let o="";if(e.includes("calc-weekly-policy-worker"))o=new URL("/iKDx/assets/calc-weekly-policy-worker-classic-DzQoiISg.js",import.meta.url),console.log("📱 使用 Classic 週線計算 Worker");else if(e.includes("calc-trend-chart-worker"))o=new URL("data:text/javascript;base64,Ly8gQ2xhc3NpYyBXb3JrZXIg54mI5pys55qE6Lao5Yui5ZyW6KGo6KiI566X5Zmo77yIaU9TIOebuOWuue+8iQ0KDQppbXBvcnRTY3JpcHRzKCdodHRwczovL3VucGtnLmNvbS9jb21saW5rL2Rpc3QvdW1kL2NvbWxpbmsuanMnKTsNCg0KZnVuY3Rpb24gY2FsY1NpZ25hbChwcm9maXREYXRhKSB7DQogICAgLy8gVE9ETzog5a+m6Zqb55qE6KiK6Jmf5L2N572u6KiI566X6YKP6LyvDQogICAgcmV0dXJuIHsgc2lnbmFsOiAn6KiK6Jmf5L2N572u57WQ5p6cJyB9Ow0KfQ0KDQphc3luYyBmdW5jdGlvbiBwcm9jZXNzU2lnbmFsKHByb2ZpdERhdGEpIHsNCiAgICBjb25zdCBzaWduYWwgPSBjYWxjU2lnbmFsKHByb2ZpdERhdGEpOw0KICAgIHJldHVybiB7IC4uLnByb2ZpdERhdGEsIHNpZ25hbCB9Ow0KfQ0KDQpjb25zdCBhcGkgPSB7DQogICAgcGluZzogKCkgPT4gKHsNCiAgICAgICAgc3RhdHVzOiAnb2snLA0KICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksDQogICAgICAgIHdvcmtlclR5cGU6ICdjbGFzc2ljLXRyZW5kLWNoYXJ0LXdvcmtlcicsDQogICAgICAgIHBsYXRmb3JtOiAnaU9TIENvbXBhdGlibGUnDQogICAgfSksDQogICAgDQogICAgcHJvY2Vzc1NpZ25hbDogcHJvY2Vzc1NpZ25hbA0KfTsNCg0KQ29tbGluay5leHBvc2UoYXBpKTsNCg0KY29uc29sZS5sb2coJ/Cfk7EgQ2xhc3NpYyBXb3JrZXIgKGlPUyDnm7jlrrkpIOi2qOWLouWcluihqOioiOeul+WZqOW3sua6luWCmeWwsee3kicpOw0K",import.meta.url),console.log("📱 使用 Classic 趨勢圖表 Worker");else if(e.includes("calc-trade-worker"))o=new URL("data:text/javascript;base64,Ly8gQ2xhc3NpYyBXb3JrZXIg54mI5pys55qE5Lqk5piT6KiI566X5Zmo77yIaU9TIOebuOWuue+8iQ0KDQppbXBvcnRTY3JpcHRzKCdodHRwczovL3VucGtnLmNvbS9jb21saW5rL2Rpc3QvdW1kL2NvbWxpbmsuanMnKTsNCg0KZnVuY3Rpb24gY2FsY1RyYWRlKGluZGljYXRvcnNEYXRhKSB7DQogICAgLy8gVE9ETzog5a+m6Zqb55qE5aCx6YWs546H6KiI566X6YKP6LyvDQogICAgcmV0dXJuIHsgdHJhZGU6ICfloLHphaznjofntZDmnpwnIH07DQp9DQoNCmFzeW5jIGZ1bmN0aW9uIHByb2Nlc3NUcmFkZShpbmRpY2F0b3JzRGF0YSkgew0KICAgIGNvbnN0IHRyYWRlID0gY2FsY1RyYWRlKGluZGljYXRvcnNEYXRhKTsNCiAgICByZXR1cm4geyAuLi5pbmRpY2F0b3JzRGF0YSwgdHJhZGUgfTsNCn0NCg0KY29uc3QgYXBpID0gew0KICAgIHBpbmc6ICgpID0+ICh7DQogICAgICAgIHN0YXR1czogJ29rJywNCiAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLA0KICAgICAgICB3b3JrZXJUeXBlOiAnY2xhc3NpYy10cmFkZS13b3JrZXInLA0KICAgICAgICBwbGF0Zm9ybTogJ2lPUyBDb21wYXRpYmxlJw0KICAgIH0pLA0KICAgIA0KICAgIHByb2Nlc3NUcmFkZTogcHJvY2Vzc1RyYWRlDQp9Ow0KDQpDb21saW5rLmV4cG9zZShhcGkpOw0KDQpjb25zb2xlLmxvZygn8J+TsSBDbGFzc2ljIFdvcmtlciAoaU9TIOebuOWuuSkg5Lqk5piT6KiI566X5Zmo5bey5rqW5YKZ5bCx57eSJyk7DQo=",import.meta.url),console.log("📱 使用 Classic 交易計算 Worker");else{console.log("⚠️ iOS 模式下暫不支援此 Worker，回退到基本實作"),this.initialized=!0;return}for(let t=0;t<Math.min(this.maxWorkers,2);t++){console.log(`初始化 iOS Classic Worker ${t}...`);try{const s=new Worker(o),i=y(s);s.onerror=a=>{console.error(`iOS Classic Worker ${t} 錯誤:`,a),this.initError=new Error(`iOS Classic Worker ${t} 錯誤: ${a.message||"Unknown error"}`)},s.onmessageerror=a=>{console.error(`iOS Classic Worker ${t} 訊息錯誤:`,a)};try{console.log(`測試 iOS Classic Worker ${t} 通訊...`),await new Promise(l=>setTimeout(l,500));const a=await Promise.race([i.ping(),new Promise((l,n)=>setTimeout(()=>n(new Error("Ping 超時")),3e3))]);console.log(`✅ iOS Classic Worker ${t} ping 成功:`,a)}catch(a){console.warn(`⚠️ iOS Classic Worker ${t} ping 失敗，但保留 Worker:`,a)}this.workers.push({worker:s,api:i,busy:!1}),this.availableWorkers.push(t)}catch(s){console.error(`❌ 建立 iOS Classic Worker ${t} 失敗:`,s),this.initError=s;break}}if(this.workers.length>0)this.initialized=!0,console.log(`✅ iOS Classic Worker Pool 初始化完成，建立 ${this.workers.length} 個 workers`);else throw new Error("無法建立任何 iOS Classic Worker")}catch(e){console.error("❌ iOS Classic Worker Pool 初始化失敗:",e),this.initError=e,this.initialized=!1}}async waitForInitialization(){this.initPromise&&await this.initPromise}async initializeWorkers(){console.log(`開始初始化 Worker Pool: ${this.workerUrl}`),console.log("瀏覽器環境診斷:",{userAgent:navigator.userAgent,isIOS:/iPad|iPhone|iPod/.test(navigator.userAgent),isSafari:/Safari/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent),workerSupport:typeof Worker<"u",moduleSupport:typeof module<"u",urlSupport:typeof URL<"u",blobSupport:typeof Blob<"u"});try{if(typeof Worker>"u")throw new Error("此瀏覽器不支援 Web Workers");const e=/iPad|iPhone|iPod/.test(navigator.userAgent),o=/Safari/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent);if(e){console.log("檢測到 iOS 裝置，進行相容性測試...");try{const t='console.log("test");',s=new Blob([t],{type:"application/javascript"});new Worker(URL.createObjectURL(s)).terminate(),console.log("✅ iOS 基本 Worker 創建測試通過")}catch(t){throw console.error("❌ iOS 基本 Worker 創建失敗:",t),new Error(`iOS Worker 基本測試失敗: ${t.message}`)}try{const t=`
                        import { expose } from 'https://unpkg.com/comlink/dist/esm/comlink.mjs';
                        expose({ test: () => 'ok' });
                    `,s=new Blob([t],{type:"application/javascript"}),i=new Worker(URL.createObjectURL(s),{type:"module"});await new Promise((a,l)=>{const n=setTimeout(()=>{i.terminate(),a()},1e3);i.onerror=c=>{const u=Q(c,"iOS ES Module Worker 測試錯誤");clearTimeout(n),i.terminate(),l(c)}}),console.log("✅ iOS ES Module Worker 測試通過")}catch(t){console.error("❌ iOS ES Module Worker 測試失敗:",t),console.log("嘗試降級到 Classic Worker...")}}for(let t=0;t<this.maxWorkers;t++){console.log(`初始化 Worker ${t}...`);try{let s,i;if(e&&o){console.log("為 iOS Safari 使用特殊初始化策略...");try{s=new Worker(this.workerUrl,{type:"module"}),console.log(`Worker ${t} ES Module 模式創建成功`)}catch(l){console.warn(`Worker ${t} ES Module 模式失敗，嘗試 Classic 模式:`,l);try{s=new Worker(this.workerUrl),console.log(`Worker ${t} Classic 模式創建成功`)}catch(n){throw console.error(`Worker ${t} Classic 模式也失敗:`,n),new Error(`iOS Worker 創建失敗: Module=${l.message}, Classic=${n.message}`)}}}else s=new Worker(this.workerUrl,{type:"module"});const a=`Worker-${t}-${this.workerUrl.toString().split("/").pop()}`;s=T(s,a),i=y(s);try{console.log(`測試 Worker ${t} Comlink 通訊...`);const l=e?2e3:500;if(await new Promise(n=>setTimeout(n,l)),typeof i.ping=="function"){const n=await Promise.race([i.ping(),new Promise((c,u)=>setTimeout(()=>u(new Error("Ping 超時")),5e3))]);console.log(`Worker ${t} ping 測試結果:`,n)}console.log(`✅ Worker ${t} 初始化和通訊測試成功`)}catch(l){if(console.warn(`⚠️ Worker ${t} 通訊測試失敗:`,l),console.warn("但 Worker 已創建，將保留以進行實際任務測試"),!e)throw l}this.workers.push({worker:s,api:i,busy:!1}),this.availableWorkers.push(t)}catch(s){if(console.error(`❌ 建立 Worker ${t} 失敗:`,s),console.error("Worker 錯誤詳細資訊:",{message:s.message,stack:s.stack,name:s.name,cause:s.cause}),this.initError=s,!e)break}}if(this.workers.length>0)this.initialized=!0,console.log(`✅ Worker Pool 初始化完成，成功建立 ${this.workers.length} 個 workers`),e&&console.log("iOS Worker Pool 狀態報告:",{totalRequested:this.maxWorkers,successfullyCreated:this.workers.length,failureRate:((this.maxWorkers-this.workers.length)/this.maxWorkers*100).toFixed(1)+"%"});else throw new Error("無法建立任何 Worker")}catch(e){console.error("❌ Worker Pool 初始化失敗:",e),console.error("初始化失敗詳細資訊:",{message:e.message,stack:e.stack,workerUrl:this.workerUrl,maxWorkers:this.maxWorkers,platform:{isIOS:/iPad|iPhone|iPod/.test(navigator.userAgent),isSafari:/Safari/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent),userAgent:navigator.userAgent}}),this.initError=e,this.initialized=!1}}onStatusChange(e){this.statusCallbacks.add(e),e(this.getStatus())}offStatusChange(e){this.statusCallbacks.delete(e)}getStatus(){return{mode:this.isIOSMode?"iOS Classic Worker":"Standard ES Module",totalWorkers:this.maxWorkers,availableWorkers:this.availableWorkers.length,busyWorkers:this.maxWorkers-this.availableWorkers.length,queuedTasks:this.queue.length,activeJobs:this.activeJobs,utilization:((this.maxWorkers-this.availableWorkers.length)/this.maxWorkers*100).toFixed(1)}}notifyStatusChange(){const e=this.getStatus();this.statusCallbacks.forEach(o=>{try{o(e)}catch(t){console.error("Worker Pool 狀態回調錯誤:",t)}})}async execute(e,...o){if(await this.waitForInitialization(),this.initError)throw new Error(`Worker Pool 初始化失敗: ${this.initError.message}`);if(!this.initialized)throw new Error("Worker Pool 尚未初始化完成");return new Promise((t,s)=>{const i=setTimeout(()=>{s(new Error(`Worker 任務 ${e} 執行超時`))},3e4);this.queue.push({method:e,args:o,resolve:a=>{clearTimeout(i),t(a)},reject:a=>{clearTimeout(i),s(a)}}),this.notifyStatusChange(),this.processQueue()})}processQueue(){if(this.queue.length===0||this.availableWorkers.length===0)return;const e=this.availableWorkers.shift(),o=this.workers[e],{method:t,args:s,resolve:i,reject:a}=this.queue.shift();o.busy=!0,this.activeJobs++,this.notifyStatusChange(),(async()=>{try{const n=await o.api[t](...s);i(n)}catch(n){console.error(`Worker 任務 ${t} 執行失敗:`,n),n.message.includes("import")||n.message.includes("module")?a(new Error(`iOS Safari Worker 相容性問題: ${n.message}`)):a(n)}finally{o.busy=!1,this.availableWorkers.push(e),this.activeJobs--,this.notifyStatusChange(),this.processQueue()}})()}async waitForAll(){for(;this.activeJobs>0||this.queue.length>0;)await new Promise(e=>setTimeout(e,10))}destroy(){this.statusCallbacks.clear(),this.workers.forEach(({worker:e})=>{e.terminate()}),this.workers=[],this.availableWorkers=[],this.queue=[],this.activeJobs=0}}class ${constructor(){this.pools=new Map}getPool(e,o,t){return this.pools.has(e)||this.pools.set(e,new G(o,t)),this.pools.get(e)}async waitForAllInitialization(){const e=Array.from(this.pools.values()).map(o=>o.waitForInitialization());await Promise.all(e)}getAllStatus(){const e={};return this.pools.forEach((o,t)=>{e[t]=o.getStatus()}),e}onAllStatusChange(e){this.pools.forEach((o,t)=>{o.onStatusChange(s=>{e(t,s,this.getAllStatus())})})}getPoolStatus(e){const o=this.pools.get(e);return o?o.getStatus():null}destroyPool(e){this.pools.has(e)&&(this.pools.get(e).destroy(),this.pools.delete(e))}destroyAll(){this.pools.forEach(e=>e.destroy()),this.pools.clear()}}const V=new $;export{q as c,V as w};
