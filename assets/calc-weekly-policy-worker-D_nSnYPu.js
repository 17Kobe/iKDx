function we(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var G={exports:{}},Se=G.exports,le;function Oe(){return le||(le=1,function(e,t){(function(r,f){e.exports=f()})(Se,function(){var r=1e3,f=6e4,D=36e5,m="millisecond",d="second",o="minute",u="hour",c="day",g="week",$="month",k="quarter",S="year",M="date",Y="Invalid Date",j=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,A=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,P={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),ordinal:function(l){var i=["th","st","nd","rd"],n=l%100;return"["+l+(i[(n-20)%10]||i[n]||i[0])+"]"}},L=function(l,i,n){var a=String(l);return!a||a.length>=i?l:""+Array(i+1-a.length).join(n)+l},H={s:L,z:function(l){var i=-l.utcOffset(),n=Math.abs(i),a=Math.floor(n/60),s=n%60;return(i<=0?"+":"-")+L(a,2,"0")+":"+L(s,2,"0")},m:function l(i,n){if(i.date()<n.date())return-l(n,i);var a=12*(n.year()-i.year())+(n.month()-i.month()),s=i.clone().add(a,$),h=n-s<0,y=i.clone().add(a+(h?-1:1),$);return+(-(a+(n-s)/(h?s-y:y-s))||0)},a:function(l){return l<0?Math.ceil(l)||0:Math.floor(l)},p:function(l){return{M:$,y:S,w:g,d:c,D:M,h:u,m:o,s:d,ms:m,Q:k}[l]||String(l||"").toLowerCase().replace(/s$/,"")},u:function(l){return l===void 0}},_="en",W={};W[_]=P;var J="$isDayjsObject",Z=function(l){return l instanceof q||!(!l||!l[J])},T=function l(i,n,a){var s;if(!i)return _;if(typeof i=="string"){var h=i.toLowerCase();W[h]&&(s=h),n&&(W[h]=n,s=h);var y=i.split("-");if(!s&&y.length>1)return l(y[0])}else{var p=i.name;W[p]=i,s=p}return!a&&s&&(_=s),s||!a&&_},O=function(l,i){if(Z(l))return l.clone();var n=typeof i=="object"?i:{};return n.date=l,n.args=arguments,new q(n)},w=H;w.l=T,w.i=Z,w.w=function(l,i){return O(l,{locale:i.$L,utc:i.$u,x:i.$x,$offset:i.$offset})};var q=function(){function l(n){this.$L=T(n.locale,null,!0),this.parse(n),this.$x=this.$x||n.x||{},this[J]=!0}var i=l.prototype;return i.parse=function(n){this.$d=function(a){var s=a.date,h=a.utc;if(s===null)return new Date(NaN);if(w.u(s))return new Date;if(s instanceof Date)return new Date(s);if(typeof s=="string"&&!/Z$/i.test(s)){var y=s.match(j);if(y){var p=y[2]-1||0,v=(y[7]||"0").substring(0,3);return h?new Date(Date.UTC(y[1],p,y[3]||1,y[4]||0,y[5]||0,y[6]||0,v)):new Date(y[1],p,y[3]||1,y[4]||0,y[5]||0,y[6]||0,v)}}return new Date(s)}(n),this.init()},i.init=function(){var n=this.$d;this.$y=n.getFullYear(),this.$M=n.getMonth(),this.$D=n.getDate(),this.$W=n.getDay(),this.$H=n.getHours(),this.$m=n.getMinutes(),this.$s=n.getSeconds(),this.$ms=n.getMilliseconds()},i.$utils=function(){return w},i.isValid=function(){return this.$d.toString()!==Y},i.isSame=function(n,a){var s=O(n);return this.startOf(a)<=s&&s<=this.endOf(a)},i.isAfter=function(n,a){return O(n)<this.startOf(a)},i.isBefore=function(n,a){return this.endOf(a)<O(n)},i.$g=function(n,a,s){return w.u(n)?this[a]:this.set(s,n)},i.unix=function(){return Math.floor(this.valueOf()/1e3)},i.valueOf=function(){return this.$d.getTime()},i.startOf=function(n,a){var s=this,h=!!w.u(a)||a,y=w.p(n),p=function(F,x){var C=w.w(s.$u?Date.UTC(s.$y,x,F):new Date(s.$y,x,F),s);return h?C:C.endOf(c)},v=function(F,x){return w.w(s.toDate()[F].apply(s.toDate("s"),(h?[0,0,0,0]:[23,59,59,999]).slice(x)),s)},I=this.$W,b=this.$M,B=this.$D,N="set"+(this.$u?"UTC":"");switch(y){case S:return h?p(1,0):p(31,11);case $:return h?p(1,b):p(0,b+1);case g:var V=this.$locale().weekStart||0,R=(I<V?I+7:I)-V;return p(h?B-R:B+(6-R),b);case c:case M:return v(N+"Hours",0);case u:return v(N+"Minutes",1);case o:return v(N+"Seconds",2);case d:return v(N+"Milliseconds",3);default:return this.clone()}},i.endOf=function(n){return this.startOf(n,!1)},i.$set=function(n,a){var s,h=w.p(n),y="set"+(this.$u?"UTC":""),p=(s={},s[c]=y+"Date",s[M]=y+"Date",s[$]=y+"Month",s[S]=y+"FullYear",s[u]=y+"Hours",s[o]=y+"Minutes",s[d]=y+"Seconds",s[m]=y+"Milliseconds",s)[h],v=h===c?this.$D+(a-this.$W):a;if(h===$||h===S){var I=this.clone().set(M,1);I.$d[p](v),I.init(),this.$d=I.set(M,Math.min(this.$D,I.daysInMonth())).$d}else p&&this.$d[p](v);return this.init(),this},i.set=function(n,a){return this.clone().$set(n,a)},i.get=function(n){return this[w.p(n)]()},i.add=function(n,a){var s,h=this;n=Number(n);var y=w.p(a),p=function(b){var B=O(h);return w.w(B.date(B.date()+Math.round(b*n)),h)};if(y===$)return this.set($,this.$M+n);if(y===S)return this.set(S,this.$y+n);if(y===c)return p(1);if(y===g)return p(7);var v=(s={},s[o]=f,s[u]=D,s[d]=r,s)[y]||1,I=this.$d.getTime()+n*v;return w.w(I,this)},i.subtract=function(n,a){return this.add(-1*n,a)},i.format=function(n){var a=this,s=this.$locale();if(!this.isValid())return s.invalidDate||Y;var h=n||"YYYY-MM-DDTHH:mm:ssZ",y=w.z(this),p=this.$H,v=this.$m,I=this.$M,b=s.weekdays,B=s.months,N=s.meridiem,V=function(x,C,U,z){return x&&(x[C]||x(a,h))||U[C].slice(0,z)},R=function(x){return w.s(p%12||12,x,"0")},F=N||function(x,C,U){var z=x<12?"AM":"PM";return U?z.toLowerCase():z};return h.replace(A,function(x,C){return C||function(U){switch(U){case"YY":return String(a.$y).slice(-2);case"YYYY":return w.s(a.$y,4,"0");case"M":return I+1;case"MM":return w.s(I+1,2,"0");case"MMM":return V(s.monthsShort,I,B,3);case"MMMM":return V(B,I);case"D":return a.$D;case"DD":return w.s(a.$D,2,"0");case"d":return String(a.$W);case"dd":return V(s.weekdaysMin,a.$W,b,2);case"ddd":return V(s.weekdaysShort,a.$W,b,3);case"dddd":return b[a.$W];case"H":return String(p);case"HH":return w.s(p,2,"0");case"h":return R(1);case"hh":return R(2);case"a":return F(p,v,!0);case"A":return F(p,v,!1);case"m":return String(v);case"mm":return w.s(v,2,"0");case"s":return String(a.$s);case"ss":return w.s(a.$s,2,"0");case"SSS":return w.s(a.$ms,3,"0");case"Z":return y}return null}(x)||y.replace(":","")})},i.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},i.diff=function(n,a,s){var h,y=this,p=w.p(a),v=O(n),I=(v.utcOffset()-this.utcOffset())*f,b=this-v,B=function(){return w.m(y,v)};switch(p){case S:h=B()/12;break;case $:h=B();break;case k:h=B()/3;break;case g:h=(b-I)/6048e5;break;case c:h=(b-I)/864e5;break;case u:h=b/D;break;case o:h=b/f;break;case d:h=b/r;break;default:h=b}return s?h:w.a(h)},i.daysInMonth=function(){return this.endOf($).$D},i.$locale=function(){return W[this.$L]},i.locale=function(n,a){if(!n)return this.$L;var s=this.clone(),h=T(n,a,!0);return h&&(s.$L=h),s},i.clone=function(){return w.w(this.$d,this)},i.toDate=function(){return new Date(this.valueOf())},i.toJSON=function(){return this.isValid()?this.toISOString():null},i.toISOString=function(){return this.$d.toISOString()},i.toString=function(){return this.$d.toUTCString()},l}(),de=q.prototype;return O.prototype=de,[["$ms",m],["$s",d],["$m",o],["$H",u],["$W",c],["$M",$],["$y",S],["$D",M]].forEach(function(l){de[l[1]]=function(i){return this.$g(i,l[0],l[1])}}),O.extend=function(l,i){return l.$i||(l(i,q,O),l.$i=!0),O},O.locale=T,O.isDayjs=Z,O.unix=function(l){return O(1e3*l)},O.en=W[_],O.Ls=W,O.p={},O})}(G)),G.exports}var Ie=Oe(),E=we(Ie),Q={exports:{}},We=Q.exports,he;function be(){return he||(he=1,function(e,t){(function(r,f){e.exports=f()})(We,function(){var r="day";return function(f,D,m){var d=function(c){return c.add(4-c.isoWeekday(),r)},o=D.prototype;o.isoWeekYear=function(){return d(this).year()},o.isoWeek=function(c){if(!this.$utils().u(c))return this.add(7*(c-this.isoWeek()),r);var g,$,k,S,M=d(this),Y=(g=this.isoWeekYear(),$=this.$u,k=($?m.utc:m)().year(g).startOf("year"),S=4-k.isoWeekday(),k.isoWeekday()>4&&(S+=7),k.add(S,r));return M.diff(Y,"week")+1},o.isoWeekday=function(c){return this.$utils().u(c)?this.day()||7:this.day(this.day()%7?c:c-7)};var u=o.startOf;o.startOf=function(c,g){var $=this.$utils(),k=!!$.u(g)||g;return $.p(c)==="isoweek"?k?this.date(this.date()-(this.isoWeekday()-1)).startOf("day"):this.date(this.date()-1-(this.isoWeekday()-1)+7).endOf("day"):u.bind(this)(c,g)}}})}(Q)),Q.exports}var xe=be(),Ye=we(xe);const oe=(e,t)=>t.some(r=>e instanceof r);let ye,me;function je(){return ye||(ye=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function Be(){return me||(me=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const ae=new WeakMap,ee=new WeakMap,X=new WeakMap;function Le(e){const t=new Promise((r,f)=>{const D=()=>{e.removeEventListener("success",m),e.removeEventListener("error",d)},m=()=>{r(K(e.result)),D()},d=()=>{f(e.error),D()};e.addEventListener("success",m),e.addEventListener("error",d)});return X.set(t,e),t}function Pe(e){if(ae.has(e))return;const t=new Promise((r,f)=>{const D=()=>{e.removeEventListener("complete",m),e.removeEventListener("error",d),e.removeEventListener("abort",d)},m=()=>{r(),D()},d=()=>{f(e.error||new DOMException("AbortError","AbortError")),D()};e.addEventListener("complete",m),e.addEventListener("error",d),e.addEventListener("abort",d)});ae.set(e,t)}let ce={get(e,t,r){if(e instanceof IDBTransaction){if(t==="done")return ae.get(e);if(t==="store")return r.objectStoreNames[1]?void 0:r.objectStore(r.objectStoreNames[0])}return K(e[t])},set(e,t,r){return e[t]=r,!0},has(e,t){return e instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in e}};function pe(e){ce=e(ce)}function _e(e){return Be().includes(e)?function(...t){return e.apply(ue(this),t),K(this.request)}:function(...t){return K(e.apply(ue(this),t))}}function Ee(e){return typeof e=="function"?_e(e):(e instanceof IDBTransaction&&Pe(e),oe(e,je())?new Proxy(e,ce):e)}function K(e){if(e instanceof IDBRequest)return Le(e);if(ee.has(e))return ee.get(e);const t=Ee(e);return t!==e&&(ee.set(e,t),X.set(t,e)),t}const ue=e=>X.get(e);function Ae(e,t,{blocked:r,upgrade:f,blocking:D,terminated:m}={}){const d=indexedDB.open(e,t),o=K(d);return f&&d.addEventListener("upgradeneeded",u=>{f(K(d.result),u.oldVersion,u.newVersion,K(d.transaction),u)}),r&&d.addEventListener("blocked",u=>r(u.oldVersion,u.newVersion,u)),o.then(u=>{m&&u.addEventListener("close",()=>m()),D&&u.addEventListener("versionchange",c=>D(c.oldVersion,c.newVersion,c))}).catch(()=>{}),o}const Te=["get","getKey","getAll","getAllKeys","count"],Ce=["put","add","delete","clear"],te=new Map;function ge(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t=="string"))return;if(te.get(t))return te.get(t);const r=t.replace(/FromIndex$/,""),f=t!==r,D=Ce.includes(r);if(!(r in(f?IDBIndex:IDBObjectStore).prototype)||!(D||Te.includes(r)))return;const m=async function(d,...o){const u=this.transaction(d,D?"readwrite":"readonly");let c=u.store;return f&&(c=c.index(o.shift())),(await Promise.all([c[r](...o),D&&u.done]))[0]};return te.set(t,m),m}pe(e=>({...e,get:(t,r,f)=>ge(t,r)||e.get(t,r,f),has:(t,r)=>!!ge(t,r)||e.has(t,r)}));const He=["continue","continuePrimaryKey","advance"],$e={},fe=new WeakMap,ke=new WeakMap,Ve={get(e,t){if(!He.includes(t))return e[t];let r=$e[t];return r||(r=$e[t]=function(...f){fe.set(this,ke.get(this)[t](...f))}),r}};async function*Fe(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;t=t;const r=new Proxy(t,Ve);for(ke.set(r,t),X.set(r,ue(t));t;)yield r,t=await(fe.get(r)||t.continue()),fe.delete(r)}function De(e,t){return t===Symbol.asyncIterator&&oe(e,[IDBIndex,IDBObjectStore,IDBCursor])||t==="iterate"&&oe(e,[IDBIndex,IDBObjectStore])}pe(e=>({...e,get(t,r,f){return De(t,r)?Fe:e.get(t,r,f)},has(t,r){return De(t,r)||e.has(t,r)}}));let ne=null;async function Ke(){return ne||(ne=await Ae("ikdx-db",1,{upgrade(e,t,r){t<1&&(e.createObjectStore("all-stocks",{keyPath:"id"}),e.createObjectStore("user-stock-info",{keyPath:"id"}).createIndex("orderIndex","order"),e.createObjectStore("user-stock-data",{keyPath:"id"}))}})),ne}function ve(){return Ke()}async function Ne(e,t){return(await ve()).get(e,t)}async function Re(e,t){return(await ve()).put(e,t)}E.extend(Ye);function re(e){if(!e||e.length===0)return[];const t=(g,$,k)=>g.slice($,k),r=(g,$)=>g.map($),f=g=>Math.min(...g),D=g=>Math.max(...g),m=g=>g.reduce(($,k)=>$+k,0),d=[];let o=e.length-1,u=o,c=E(e[o][0],"YYYYMMDD").startOf("isoWeek");for(;o>=0;){if(E(e[o][0],"YYYYMMDD").isBefore(c)||o===0){const g=o+1,$=u,k=t(e,g,$+1),S=r(k,W=>W[2]),M=r(k,W=>W[3]),Y=r(k,W=>W.length>=6?W[5]:0),j=e[$][0],A=e[g][1],P=e[$][4],L=f(M),H=D(S),_=m(Y);d.push([j,A,H,L,P,_]),u=g-1,c=E(e[o][0],"YYYYMMDD").startOf("isoWeek")}o-=1}return d.reverse()}function se(e){if(!e||e.length===0)return{data:[],predictGoldPrice:null,predictDeadPrice:null};const t=(M,Y,j)=>M.slice(Y,j),r=(M,Y)=>M.map(Y),f=M=>Math.min(...M),D=M=>Math.max(...M);let m=[],d=0,o=0,u=0,c=0,g=0,$=0,k=null,S=null;for(let M=0;M<=e.length-1;M+=1){const Y=M-8<0?0:M-8,j=M,A=t(e,Y,j+1),P=r(A,T=>T[2]),L=r(A,T=>T[3]),H=f(L),_=D(P),W=e[M][4];d=_-H!==0?(W-H)/(_-H)*100:100,c=2/3*o+1/3*d,g=2/3*u+1/3*c,$=3*g-2*c,o=c,u=g;const J=e[j][0];m.push([J,c,g,$]),M===e.length-1&&(P.slice(0,-1),L.slice(0,-1),P[P.length-1],L[L.length-1])}return{data:m,predictGoldPrice:k,predictDeadPrice:S}}function ie(e){if(!e||e.length===0)return[];const t=5;let r=[],f=[],D=[],m=0,d=0;for(let o=0;o<e.length;o++){let u=e[o][4];if(o===0)f.push(0),D.push(0);else{let c=u-e[o-1][4];f.push(Math.max(c,0)),D.push(Math.max(-c,0))}if(o>=t?(m=(m*(t-1)+f[o])/t,d=(d*(t-1)+D[o])/t):(m=(m*(o+1)+f[o])/(o+2),d=(d*(o+1)+D[o])/(o+2)),o>=t-1){let c=m/d;r.push([e[o][0],100-100/(1+c)])}}return r}const Me={calcPolicy:async function(e){try{const{stockId:t,type:r,newDailyData:f,...D}=e;if(!t)throw new Error("stockId 參數必須提供");let m=await Ne("user-stock-data",t),d=[],o=[];m&&m.daily&&(d=[...m.daily],o=m.weekly||[]),f&&f.length>0&&(d=[...d,...f]);let u=[];if(f&&f.length>0&&o.length>0){const k=o[o.length-1][0],S=E(k,"YYYYMMDD").startOf("isoWeek"),M=f[0][0];if(E(M,"YYYYMMDD").startOf("isoWeek").isSameOrBefore(S)){const j=d.filter(P=>E(P[0],"YYYYMMDD").startOf("isoWeek").isSameOrAfter(S)),A=re(j);u=[...o.slice(0,-1),...A]}else{const j=re(f);u=[...o,...j]}}else u=re(d);if(u.length===0)throw new Error("無法產生週線資料，請檢查日線資料格式");let c,g;if(m&&m.weeklyKdj&&m.weeklyRsi&&o.length>0&&u.length>o.length){const k=u.length-o.length;k===u.length-o.length&&k<=2,c=se(u),g=ie(u)}else c=se(u),g=ie(u);const $={id:t,daily:d,weekly:u,weeklyKdj:c.data,weeklyRsi:g,lastUpdated:E().format("YYYY-MM-DD HH:mm:ss"),fetchedAt:E().format("YYYY-MM-DD HH:mm:ss")};return m&&Object.assign($,m,$),await Re("user-stock-data",$),{success:!0,stockId:t,weekly:u.slice(-26),weeklyKdj:c.data.slice(-26),weeklyRsi:g.slice(-26),processedAt:new Date().toISOString()}}catch(t){return{success:!1,error:t.message,processedAt:new Date().toISOString()}}},ping:async function(){return"Native Worker Pong! "+new Date().toISOString()}};self.onmessage=async function(e){const{messageId:t,method:r,params:f}=e.data;try{if(Me[r]){const D=await Me[r](f);self.postMessage({messageId:t,result:D,error:null})}else throw new Error(`未知的方法: ${r}`)}catch(D){self.postMessage({messageId:t,result:null,error:D.message})}};
