# 📈 股票價格抓取系統使用說明

## 🚀 功能特色

本系統提供高效率的股票價格抓取功能，具備以下特色：

- ✅ **智慧快取機制**：使用 IndexedDB 快取股票資料，避免重複請求
- ✅ **批量併發抓取**：支援多支股票同時抓取，提升效率
- ✅ **自動重新整理**：下拉重新整理功能，手動更新股票價格
- ✅ **快取過期管理**：自動清理過期快取資料
- ✅ **錯誤容錯機制**：API 失敗時使用舊快取資料

## 📊 資料庫結構

使用現有的 `ikdx-db` 資料庫，包含以下資料表：

- `all-stocks`: 所有股票基本資料
- `user-stocks`: 使用者追蹤的股票清單
- `stock-price-data`: 股票價格快取資料

## 🔧 主要功能

### 1. 新增股票時自動抓取價格

```javascript
// 在 stockStore.js 中
await stockStore.addStock({
    id: '2330',
    name: '台積電',
    code: '2330',
});
// 會自動在背景抓取該股票的價格資料
```

### 2. 載入頁面時批量更新所有股票

```javascript
// 在 Stock.vue 中，頁面載入時會自動執行
await stockStore.loadUserStocks();
// 會批量更新所有使用者股票的價格資料
```

### 3. 手動重新整理

```javascript
// 下拉重新整理功能
await stockStore.refreshAllStockPrices();
```

## 📁 檔案結構

```
src/
├── services/
│   ├── stockPriceService.js      # 股票價格服務核心
│   └── stockPriceServiceTest.js  # 測試檔案
├── stores/
│   └── stockStore.js             # 股票狀態管理（已更新）
├── pages/
│   └── Stock.vue                 # 股票頁面（已更新下拉重新整理）
└── lib/
    └── idb.js                    # IndexedDB 操作
```

## ⚡ 效能優化

1. **併發控制**：預設併發數為 3，避免過多請求造成伺服器負擔
2. **快取機制**：30 分鐘內的資料直接使用快取
3. **批次延遲**：批次間 100ms 延遲，避免過於頻繁的請求
4. **錯誤處理**：API 失敗時回退到快取資料

## 🎯 使用方式

### 在頁面中使用

```vue
<template>
    <PullRefresh v-model="isRefreshing" @refresh="onRefresh">
        <!-- 股票列表 -->
    </PullRefresh>
</template>

<script setup>
    import { useStockStore } from '@/stores/stockStore';

    const stockStore = useStockStore();

    // 下拉重新整理
    async function onRefresh() {
        try {
            const result = await stockStore.refreshAllStockPrices();
            showToast(result.message);
        } finally {
        }
    }
</script>
```

### 直接使用服務

```javascript
import { getStockData, batchFetchStockData, getCacheStats } from '@/services/stockPriceService';

// 取得單一股票資料
const stockData = await getStockData('2330');

// 批量抓取股票資料
const results = await batchFetchStockData(['2330', '2317', '2454']);

// 取得快取統計
const stats = await getCacheStats();
```

## 🧪 測試

執行測試功能：

```javascript
import { testStockPriceService } from '@/services/stockPriceServiceTest';

// 測試所有功能
await testStockPriceService();
```

## 📝 資料格式

### 股票價格資料結構

```javascript
{
    id: "2330",                    // 股票代碼（主鍵）
    stockCode: "2330",             // 股票代碼
    data: [...],                   // 原始股票資料
    lastUpdated: "2025-01-01T...", // 最後更新時間
    fetchedAt: "2025-01-01 10:30"  // 抓取時間
}
```

### 處理後的股票資料

```javascript
{
    id: "2330",
    name: "台積電",
    code: "2330",
    price: 589.0,           // 最新價格
    change: 12.0,           // 漲跌
    changePercent: 2.08,    // 漲跌幅
    weeklyKD: 65,           // 週KD值
    rsi: 58,                // RSI值
    lastUpdated: "2025-01-01T..."
}
```

## 🔍 除錯資訊

系統會在 Console 中輸出詳細的除錯資訊：

- 抓取進度
- 快取使用狀況
- 錯誤訊息
- 效能統計

查看 Chrome DevTools > Application > IndexedDB > ikdx-db 可以檢視快取資料。
